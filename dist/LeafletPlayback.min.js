(function(t){var i;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("object"==typeof module&&"object"==typeof module.exports)i=require("leaflet"),module.exports=t(i);else{if(void 0===window.L)throw"Leaflet must be loaded first";t(window.L)}})(function(t){return t.Playback=t.Playback||{},t.Playback.Util=t.Class.extend({statics:{DateStr:function(t){return new Date(t).toDateString()},TimeStr:function(t){var i=new Date(t),e=i.getHours(),o=i.getMinutes(),n=i.getSeconds(),a=t/1e3,r=(a-Math.floor(a)).toFixed(2).slice(1),s="AM";return e>11&&(e%=12,s="PM"),0===e&&(e=12),o<10&&(o="0"+o),n<10&&(n="0"+n),e+":"+o+":"+n+r+" "+s},ParseGPX:function(t){for(var i={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{time:[],speed:[],altitude:[]},bbox:[]},e=$.parseXML(t),o=$(e).find("trkpt"),n=0,a=o.length;n<a;n++){var r=o[n],s=parseFloat(r.getAttribute("lat")),l=parseFloat(r.getAttribute("lon")),c=$(r).find("time").text(),h=$(r).find("ele").text(),p=new Date(c).getTime(),_=parseFloat(h),k=i.geometry.coordinates,u=i.properties,d=u.time,m=i.properties.altitude;k.push([l,s]),d.push(p),m.push(_)}return i}}}),t.Playback=t.Playback||{},t.Playback.MoveableMarker=t.Marker.extend({initialize:function(i,e,o){var n=e.marker||{};jQuery.isFunction(n)&&(n=n(o)),t.Marker.prototype.initialize.call(this,i,n),this.popupContent="",this.popupOptions={},this.tooltipContent="",this.locationWrapper={},this.tooltipOptions={},this.feature=o,n.getPopup&&(this.popupContent=n.getPopup(o)),n.getTooltip&&(this.tooltipContent=n.getTooltip(o)),n.getLocationWrapper&&(this.locationWrapper=n.getLocationWrapper(o)),n.getTooltipOptions&&(this.tooltipOptions=n.getTooltipOptions(o)),newLatLng=this.latlngCoords(i,null),e.getLocationWrapper&&(this.locationWrapper=n.getLocationWrapper,newLatLng=this.latlngCoords(i,this.locationWrapper)),e.popups&&(popupLabel=this.getPopupContent()+this.newLatLng,this.bindPopup(popupLabel,this.getPopupOptions())),e.tooltips&&(tooltipLabel=this.getTooltipContent()+this.newLatLng,this.bindTooltip(tooltipLabel,this.getTooltipOptions()))},getPopupContent:function(){return""!==this.popupContent?this.popupContent:""},getPopupOptions:function(){return""!==this.popupOptions?this.popupOptions:null},getTooltipContent:function(){return""!==this.tooltipContent?this.tooltipContent:""},getLocationWrapper:function(){return""!==this.locationWrapper?this.locationWrapper:null},getTooltipOptions:function(){return""!==this.tooltipOptions?this.tooltipOptions:null},latlngCoords:function(t,i){return removeExtras=t.toString(),null!==i&&void 0!==i.start&&void 0!==i.end&&(removeExtras=i.start+t.toString().replace("LatLng(","").replace(")","")+i.end),removeExtras},move:function(i,e){t.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[t.DomUtil.TRANSITION]="all "+e+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[t.DomUtil.TRANSITION]="all "+e+"ms linear"),this._tooltip&&this._tooltip._wrapper&&(this._tooltip._wrapper.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this._shadow&&(this._shadow.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this.setLatLng(i),this._newLatLng=this.latlngCoords(this._latlng,this.locationWrapper),this._popup&&this._popup.setContent(this.getPopupContent()+this._newLatLng),this._tooltip&&this._tooltip.setContent(this.getTooltipContent()+this._newLatLng)},_old__setPos:t.Marker.prototype._setPos,_updateImg:function(i,e,o){e=t.point(o).divideBy(2)._subtract(t.point(e));var n="";n+=" translate("+-e.x+"px, "+-e.y+"px)",n+=" rotate("+this.options.iconAngle+"deg)",n+=" translate("+e.x+"px, "+e.y+"px)",i.style[t.DomUtil.TRANSFORM]+=n},setIconAngle:function(t){this.options.iconAngle=t,this._map&&this.update()},_setPos:function(i){if(this._icon&&(this._icon.style[t.DomUtil.TRANSFORM]=""),this._shadow&&(this._shadow.style[t.DomUtil.TRANSFORM]=""),this._old__setPos.apply(this,[i]),this.options.iconAngle){var e,o=this.options.icon.options.iconAnchor,n=this.options.icon.options.iconSize;this._icon&&(e=this._icon,this._updateImg(e,o,n)),this._shadow&&(n=this.options.icon.options.shadowSize,e=this._shadow,this._updateImg(e,o,n))}}}),t.Playback=t.Playback||{},t.Playback.Track=t.Class.extend({initialize:function(t,i){i=i||{};var e=i.tickLen||250;this._staleTime=i.staleTime||36e5,this._fadeMarkersWhenStale=i.fadeMarkersWhenStale||!1,this._geoJSON=t,this._tickLen=e,this._ticks=[],this._marker=null,this._orientations=[];var o,n=t.properties.time;this._orientIcon=i.orientIcons;var a,r,s=t.geometry.coordinates,l=s[0],c=s[1],h=n[0],p=h,_=n[1],k=p%e;if(1===n.length)return 0!==k&&(p+=e-k),this._ticks[p]=s[0],this._orientations[p]=0,this._startTime=p,void(this._endTime=p);for(0!==k?(a=e-k,r=a/(_-h),p+=a,this._ticks[p]=this._interpolatePoint(l,c,r),this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]):(this._ticks[p]=l,this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]),this._startTime=p,p+=e;p<_;)r=(p-h)/(_-h),this._ticks[p]=this._interpolatePoint(l,c,r),this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p],p+=e;for(var u=1,d=s.length;u<d;u++)for(l=s[u],c=s[u+1],p=h=n[u],_=n[u+1],k=p%e,0!==k&&_?(a=e-k,r=a/(_-h),p+=a,this._ticks[p]=this._interpolatePoint(l,c,r),c?(this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]):this._orientations[p]=o):(this._ticks[p]=l,c?(this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]):this._orientations[p]=o),p+=e;p<_;)r=(p-h)/(_-h),_-h>i.maxInterpolationTime?(this._ticks[p]=l,c?(this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]):this._orientations[p]=o):(this._ticks[p]=this._interpolatePoint(l,c,r),c?(this._orientations[p]=this._directionOfPoint(l,c),o=this._orientations[p]):this._orientations[p]=o),p+=e;this._endTime=p-e,this._lastTick=this._ticks[this._endTime]},_interpolatePoint:function(t,i,e){try{var o=[i[0]-t[0],i[1]-t[1]],n=[o[0]*e,o[1]*e];return[t[0]+n[0],t[1]+n[1]]}catch(o){console.log("err: cant interpolate a point"),console.log(["start",t]),console.log(["end",i]),console.log(["ratio",e])}},_directionOfPoint:function(t,i){return this._getBearing(t[1],t[0],i[1],i[0])},_getBearing:function(t,i,e,o){t=this._radians(t),i=this._radians(i),e=this._radians(e),o=this._radians(o);var n=o-i,a=Math.log(Math.tan(e/2+Math.PI/4)/Math.tan(t/2+Math.PI/4));return Math.abs(n)>Math.PI&&(n=n>0?-(2*Math.PI-n):2*Math.PI+n),(this._degrees(Math.atan2(n,a))+360)%360},_radians:function(t){return t*(Math.PI/180)},_degrees:function(t){return t*(180/Math.PI)},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTickMultiPoint:function(){for(var t=this.getStartTime(),i=this.getEndTime(),e=[],o=[];t<=i;)o.push(t),e.push(this.tick(t)),t+=this._tickLen;return{type:"Feature",geometry:{type:"MultiPoint",coordinates:e},properties:{time:o}}},trackPresentAtTick:function(t){return t>=this._startTime},trackStaleAtTick:function(t){return this._endTime+this._staleTime<=t},tick:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._ticks[t]},courseAtTime:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._orientations[t]},setMarker:function(i,e){var o=null;if(o=i?this.tick(i):this.getFirstTick(),o){var n=new t.LatLng(o[1],o[0]);this._marker=new t.Playback.MoveableMarker(n,e,this._geoJSON),e.mouseOverCallback&&this._marker.on("mouseover",e.mouseOverCallback),e.clickCallback&&this._marker.on("click",e.clickCallback),this._fadeMarkersWhenStale&&!this.trackPresentAtTick(i)&&this._marker.setOpacity(0)}return this._marker},moveMarker:function(t,i,e){this._marker&&(this._fadeMarkersWhenStale&&(this.trackPresentAtTick(e)?this._marker.setOpacity(1):this._marker.setOpacity(0),this.trackStaleAtTick(e)&&this._marker.setOpacity(.25)),this._orientIcon&&this._marker.setIconAngle(this.courseAtTime(e)),this._marker.move(t,i))},getMarker:function(){return this._marker}}),t.Playback=t.Playback||{},t.Playback.TrackController=t.Class.extend({initialize:function(t,i,e){this.options=e||{},this._map=t,this._tracks=[],this.setTracks(i)},clearTracks:function(){for(;this._tracks.length>0;){var t=this._tracks.pop(),i=t.getMarker();i&&this._map.removeLayer(i)}},setTracks:function(t){this.clearTracks(),this.addTracks(t)},addTracks:function(t){if(t)if(t instanceof Array)for(var i=0,e=t.length;i<e;i++)this.addTrack(t[i]);else this.addTrack(t)},addTrack:function(t,i){if(t){var e=t.setMarker(i,this.options);e&&(e.addTo(this._map),this._tracks.push(t))}},tock:function(i,e){for(var o=0,n=this._tracks.length;o<n;o++){var a=this._tracks[o].tick(i),r=new t.LatLng(a[1],a[0]);this._tracks[o].moveMarker(r,e,i)}},getStartTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getStartTime();for(var i=1,e=this._tracks.length;i<e;i++){var o=this._tracks[i].getStartTime();o<t&&(t=o)}}return t},getEndTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getEndTime();for(var i=1,e=this._tracks.length;i<e;i++){var o=this._tracks[i].getEndTime();o>t&&(t=o)}}return t},getTracks:function(){return this._tracks}}),t.Playback=t.Playback||{},t.Playback.Clock=t.Class.extend({initialize:function(i,e,o){this._trackController=i,this._callbacksArry=[],e&&this.addCallback(e),t.setOptions(this,o),this._speed=this.options.speed,this._tickLen=this.options.tickLen,this._cursor=i.getStartTime(),this._transitionTime=this._tickLen/this._speed},_tick:function(t){t._cursor>t._trackController.getEndTime()?clearInterval(t._intervalID):(t._trackController.tock(t._cursor,t._transitionTime),t._callbacks(t._cursor),t._cursor+=t._tickLen)},_callbacks:function(t){for(var i=this._callbacksArry,e=0,o=i.length;e<o;e++)i[e](t)},addCallback:function(t){this._callbacksArry.push(t)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return!!this._intervalID},setSpeed:function(t){this._speed=t,this._transitionTime=this._tickLen/t,this._intervalID&&(this.stop(),this.start())},setCursor:function(t){var i=parseInt(t);if(i){var e=i%this._tickLen;0!==e&&(i+=this._tickLen-e),this._cursor=i,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}}),t.Playback=t.Playback||{},t.Playback.TracksLayer=t.Class.extend({initialize:function(i,e){var o=e.layer||{};jQuery.isFunction(o)&&(o=o(feature)),o.pointToLayer||(o.pointToLayer=function(i,e){return new t.CircleMarker(e,{radius:5})}),this.layer=new t.GeoJSON(null,o);var n={"GPS Tracks":this.layer};t.control.layers(null,n,{collapsed:!1}).addTo(i)},clearLayer:function(){for(var t in this.layer._layers)this.layer.removeLayer(this.layer._layers[t])},addLayer:function(t){this.layer.addData(t)}}),t.Playback=t.Playback||{},t.Playback.DateControl=t.Control.extend({options:{position:"bottomleft",dateFormatFn:t.Playback.Util.DateStr,timeFormatFn:t.Playback.Util.TimeStr},initialize:function(i,e){t.setOptions(this,e),this.playback=i},onAdd:function(i){this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var e=this,o=this.playback,n=o.getTime(),a=t.DomUtil.create("div","datetimeControl",this._container);return this._date=t.DomUtil.create("p","",a),this._time=t.DomUtil.create("p","",a),this._date.innerHTML=this.options.dateFormatFn(n),this._time.innerHTML=this.options.timeFormatFn(n),o.addCallback(function(t){e._date.innerHTML=e.options.dateFormatFn(t),e._time.innerHTML=e.options.timeFormatFn(t)}),this._container}}),t.Playback.PlayControl=t.Control.extend({options:{position:"bottomright"},initialize:function(t){this.playback=t},onAdd:function(i){function e(){n.isPlaying()?(n.stop(),o._button.innerHTML="Play"):(n.start(),o._button.innerHTML="Stop")}this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var o=this,n=this.playback;n.setSpeed(100);var a=t.DomUtil.create("div","playControl",this._container);this._button=t.DomUtil.create("button","",a),this._button.innerHTML="Play";var r=t.DomEvent.stopPropagation;return t.DomEvent.on(this._button,"click",r).on(this._button,"mousedown",r).on(this._button,"dblclick",r).on(this._button,"click",t.DomEvent.preventDefault).on(this._button,"click",e,this),this._container}}),t.Playback.SliderControl=t.Control.extend({options:{position:"bottomleft"},initialize:function(t){this.playback=t},onAdd:function(i){function e(t){var i=Number(t.target.value);n.setCursor(i)}this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var o=this,n=this.playback;return this._slider=t.DomUtil.create("input","slider",this._container),this._slider.type="range",this._slider.min=n.getStartTime(),this._slider.max=n.getEndTime(),this._slider.value=n.getTime(),t.DomEvent.disableClickPropagation(this._slider),t.DomEvent.on(this._slider,"change",e,this).on(this._slider,"mousemove",e,this),n.addCallback(function(t){o._slider.value=t}),i.on("playback:add_tracks",function(){o._slider.min=n.getStartTime(),o._slider.max=n.getEndTime(),o._slider.value=n.getTime()}),this._container}}),t.Playback=t.Playback.Clock.extend({statics:{MoveableMarker:t.Playback.MoveableMarker,Track:t.Playback.Track,TrackController:t.Playback.TrackController,Clock:t.Playback.Clock,Util:t.Playback.Util,TracksLayer:t.Playback.TracksLayer,PlayControl:t.Playback.PlayControl,DateControl:t.Playback.DateControl,SliderControl:t.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3e5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(i,e,o,n){t.setOptions(this,n),this._map=i,this._trackController=new t.Playback.TrackController(i,null,this.options),t.Playback.Clock.prototype.initialize.call(this,this._trackController,o,this.options),this.options.tracksLayer&&(this._tracksLayer=new t.Playback.TracksLayer(i,n)),this.setData(e),this.options.playControl&&(this.playControl=new t.Playback.PlayControl(this),this.playControl.addTo(i)),this.options.sliderControl&&(this.sliderControl=new t.Playback.SliderControl(this),this.sliderControl.addTo(i)),this.options.dateControl&&(this.dateControl=new t.Playback.DateControl(this,n),this.dateControl.addTo(i))},clearData:function(){this._trackController.clearTracks(),this._tracksLayer&&this._tracksLayer.clearLayer()},setData:function(t){this.clearData(),this.addData(t,this.getTime()),this.setCursor(this.getStartTime())},addData:function(i,e){if(i){if(i instanceof Array)for(var o=0,n=i.length;o<n;o++)this._trackController.addTrack(new t.Playback.Track(i[o],this.options),e);else this._trackController.addTrack(new t.Playback.Track(i,this.options),e);this._map.fire("playback:set:data"),this.options.tracksLayer&&this._tracksLayer.addLayer(i)}},destroy:function(){this.clearData(),this.playControl&&this._map.removeControl(this.playControl),this.sliderControl&&this._map.removeControl(this.sliderControl),this.dateControl&&this._map.removeControl(this.dateControl)}}),t.Map.addInitHook(function(){this.options.playback&&(this.playback=new t.Playback(this))}),t.playback=function(i,e,o,n){return new t.Playback(i,e,o,n)},t.Playback});